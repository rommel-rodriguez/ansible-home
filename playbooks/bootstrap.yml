---
- name: Bootstrap hosts for Ansible
  hosts: ubuntu_all
  gather_facts: false
  vars:
    # Use a temporary connection user that already works (change if needed)
    ansible_user: ubuntu
  serial: 1  # safety first

  pre_tasks:
    - name: Ensure Python & sudo exist (raw)
      raw: |
        set -eu
        export DEBIAN_FRONTEND=noninteractive
        if ! command -v python3 >/dev/null 2>&1; then
          apt-get update -y
          apt-get install -y python3
        fi
        if ! command -v sudo >/dev/null 2>&1; then
          apt-get update -y
          apt-get install -y sudo
        fi

  tasks:
    - name: Create 'ansible' admin user
      become: true
      ansible.builtin.user:
        name: ansible
        comment: Ansible Automation
        groups: sudo
        shell: /bin/bash
        create_home: yes

    - name: Authorize the automation public key
      become: true
      ansible.builtin.authorized_key:
        user: ansible
        key: "{{ lookup('file', lookup('env','HOME') + '/.ssh/id_ansible.pub') }}"
        state: present

    - name: Allow passwordless sudo for 'ansible' (NOPASSWD)
      become: true
      ansible.builtin.copy:
        dest: /etc/sudoers.d/99-ansible
        content: "ansible ALL=(ALL) NOPASSWD:ALL\n"
        owner: root
        group: root
        mode: '0440'
        validate: 'visudo -cf %s'
